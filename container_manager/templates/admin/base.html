{% extends "admin/base.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- Custom CSS -->
<link rel="stylesheet" type="text/css" href="{% static 'container_manager/css/admin.css' %}">

<style>
/* Quick inline styles for container management */
.container-status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.container-status-connected {
    background-color: #28a745;
}

.container-status-failed {
    background-color: #dc3545;
}

.container-status-inactive {
    background-color: #6c757d;
}

.job-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.job-actions .btn {
    font-size: 0.8em;
    padding: 2px 8px;
}

.logs-container {
    max-height: 400px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
}

.log-section {
    margin-bottom: 15px;
}

.log-section h5 {
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 5px;
}

.stdout-log {
    color: #000;
}

.stderr-log {
    color: #dc3545;
}

.docker-log {
    color: #17a2b8;
}
</style>

{% endblock %}

{% block extrastyle %}
{{ block.super }}
{% endblock %}

{% block extrajs %}
{{ block.super }}

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script src="{% static 'container_manager/js/admin.js' %}"></script>

<script>
// HTMX configuration
document.addEventListener('DOMContentLoaded', function() {
    // Configure HTMX
    htmx.config.defaultSwapStyle = 'innerHTML';
    htmx.config.defaultSwapDelay = 100;
    
    // Auto-refresh job status every 30 seconds
    if (window.location.pathname.includes('/containerjob/')) {
        setInterval(function() {
            const statusElements = document.querySelectorAll('[hx-get]');
            statusElements.forEach(function(el) {
                htmx.trigger(el, 'refresh');
            });
        }, 30000);
    }
});

// Function to show real-time logs
function showLogs(jobId) {
    const modal = document.getElementById('logsModal');
    const logsContainer = document.getElementById('logsContainer');
    
    // Set up WebSocket connection for real-time logs
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/logs/${jobId}/`;
    
    const socket = new WebSocket(wsUrl);
    
    socket.onopen = function(e) {
        console.log('WebSocket connection opened for job:', jobId);
    };
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'log_update') {
            updateLogsDisplay(data.logs);
        }
    };
    
    socket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };
    
    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    // Close socket when modal is closed
    modal.addEventListener('hidden.bs.modal', function() {
        socket.close();
    });
}

function updateLogsDisplay(logs) {
    const container = document.getElementById('logsContainer');
    
    let html = '';
    if (logs.stdout) {
        html += `
            <div class="log-section">
                <h5>Standard Output</h5>
                <pre class="stdout-log">${logs.stdout}</pre>
            </div>
        `;
    }
    
    if (logs.stderr) {
        html += `
            <div class="log-section">
                <h5>Standard Error</h5>
                <pre class="stderr-log">${logs.stderr}</pre>
            </div>
        `;
    }
    
    if (logs.docker) {
        html += `
            <div class="log-section">
                <h5>Docker Logs</h5>
                <pre class="docker-log">${logs.docker}</pre>
            </div>
        `;
    }
    
    container.innerHTML = html;
}
</script>

{% endblock %}

{% block footer %}
{{ block.super }}

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Container Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logsContainer" class="logs-container">
                    Loading logs...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}